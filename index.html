<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>VKRN ULP Wonosobo</title>
  <style>
    :root { --pri:#3498db; --bg:#f5f6fa; }
    *{box-sizing:border-box;font-family:Segoe UI,Arial,sans-serif}
    body{margin:0;background:var(--bg)}
    .wrap{max-width:1100px;margin:auto;padding:28px}
    h1{margin:0 0 16px;text-align:center;color:#2c3e50}
    .top-info{color:#666;text-align:center;margin-bottom:14px}
    .btn{display:inline-flex;align-items:center;gap:8px;border:none;border-radius:8px;padding:10px 14px;cursor:pointer;background:#27ae60;color:#fff}
    .btn:hover{opacity:.92}
    .search{display:flex;gap:8px;margin:14px auto 20px;max-width:900px}
    .search input{flex:1;padding:12px 14px;border:1px solid #cfd6e0;border-radius:8px;font-size:16px;background:#fff}
    .search button{padding:12px 18px;border:none;background:var(--pri);color:#fff;border-radius:8px;cursor:pointer}
    .search button:hover{filter:brightness(.95)}
    .count{color:#6b7785;margin:8px 0 14px;font-weight:600}
    .card{background:#fff;border:1px solid #e9eef5;border-radius:12px;padding:14px 16px;margin-bottom:12px;box-shadow:0 2px 6px rgba(0,0,0,.04)}
    .kv{display:grid;grid-template-columns:220px 1fr;gap:10px 14px;font-size:14px}
    .kv div b{color:#2c3e50}
    .idpel{background:#e8f6ff;border-left:3px solid var(--pri);padding:8px;border-radius:6px;margin-bottom:10px;font-weight:700}
    .warn{background:#fff3cd;border:1px solid #ffe08a;color:#856404;border-radius:10px;padding:14px;margin-top:8px}
    footer{text-align:center;color:#8a8f99;margin-top:28px;font-size:14px}
    @media(max-width:720px){.kv{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>VKRN ULP Wonosobo</h1>

    <div class="top-info">
      Database terakhir diupdate: <span id="lastUpdate">-</span><br/>
      <button class="btn" id="btnRefresh">ðŸ”„ Refresh Database</button>
    </div>

    <div class="search">
      <input id="q" placeholder="Cari IDPEL / Nomor Meter / Nama / Alamat..." />
      <button id="go">Cari</button>
    </div>

    <div id="out"></div>

    <footer>
      @TELWBO<br/>AHLINe PAK DAYAT
    </footer>
  </div>

<script>
/* ---------- UTIL ---------- */
// Parser CSV robust: dukung ; , atau \t + quotes
function parseCSV(text){
  if (text.charCodeAt(0)===0xFEFF) text=text.slice(1);
  const firstLine=(text.split(/\r?\n/)[0]||'');
  let delim=';';
  const score = {
    ';': (firstLine.match(/;/g)||[]).length,
    ',': (firstLine.match(/,/g)||[]).length,
    '\t': (firstLine.match(/\t/g)||[]).length
  };
  // pilih delimiter terbanyak; default ; agar file sanxing aman
  delim = Object.entries(score).sort((a,b)=>b[1]-a[1])[0][0];

  const rows=[]; let row=[], field='', inQuotes=false;
  for (let i=0;i<text.length;i++){
    const c=text[i];
    if (inQuotes){
      if (c==='"'){
        if (text[i+1]==='"'){ field+='"'; i++; }
        else { inQuotes=false; }
      } else { field+=c; }
    } else {
      if (c==='"'){ inQuotes=true; }
      else if (c===delim){ row.push(field.trim()); field=''; }
      else if (c==='\n'){ row.push(field.trim()); if(row.some(v=>v!=='')) rows.push(row); row=[]; field=''; }
      else if (c!=='\r'){ field+=c; }
    }
  }
  if (field.length||row.length){ row.push(field.trim()); if(row.some(v=>v!=='')) rows.push(row); }

  return {rows, delim};
}

const clean = s => (s??'').toString().trim();

function makeMapsLink(obj){
  // 1) kalau ada kolom yang sudah url maps
  for (const [k,v] of Object.entries(obj)){
    const sv = clean(v);
    if (/https?:\/\/(www\.)?google\.[^/]+\/maps\?q=/i.test(sv)) return sv;
  }
  // 2) KOORDINAT_X / KOORDINAT_Y
  const kxKey = Object.keys(obj).find(k=>k.toUpperCase().includes('KOORDINAT_X'));
  const kyKey = Object.keys(obj).find(k=>k.toUpperCase().includes('KOORDINAT_Y'));
  if (kxKey && kyKey){
    let x = clean(obj[kxKey]), y = clean(obj[kyKey]);
    // perbaiki bentuk "-7 204426" -> "-7.204426"
    if (x && !x.includes('.') && x.includes(' ')) x = x.replace(/\s+/g,'.');
    if (y && !y.includes('.') && y.includes(' ')) y = y.replace(/\s+/g,'.');
    if (x && y && !isNaN(Number(x)) && !isNaN(Number(y))){
      return `https://www.google.com/maps?q=${x},${y}`;
    }
  }
  return '';
}

/* ---------- DATA LOADER ---------- */
let DATA=[];

async function loadOne(file){
  try{
    const resp = await fetch(`${file}?t=${Date.now()}`);
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    const txt = await resp.text();
    const {rows} = parseCSV(txt);
    if (!rows.length) return [];
    const headers = rows[0].map(h=>clean(h));
    const out=[];
    for (let i=1;i<rows.length;i++){
      const r=rows[i];
      if (!r || !r.length) continue;
      const obj={};
      for (let j=0;j<headers.length;j++){
        const key = headers[j] || `COL_${j+1}`;
        obj[key] = clean(r[j]);
      }
      // buang baris kosong total
      if (!Object.values(obj).every(v => v==='')) out.push(obj);
    }
    return out;
  }catch(e){
    console.warn('Gagal load', file, e);
    return [];
  }
}

async function loadAll(){
  DATA = [];
  // 1) dataset KRN (koma)
  DATA.push(...await loadOne('vkrn.csv'));
  // 2) dataset Sanxing: coba nama normal dan fallback "csv.csv"
  let san = await loadOne('vkrn_sanxing.csv');
  if (!san.length) san = await loadOne('vkrn_sanxing.csv.csv');
  DATA.push(...san);

  document.getElementById('lastUpdate').textContent =
    new Date().toLocaleString('id-ID');

  console.log('Total records:', DATA.length);
}

/* ---------- SEARCH & RENDER ---------- */
function search(q){
  q = clean(q);
  if (!q){ renderWarn('Silakan masukkan kata kunci.'); return; }

  const isNumeric = /^\d+$/.test(q);
  let results = [];

  if (isNumeric){
    // exact match untuk angka (IDPEL/No Meter)
    const needle = q;
    results = DATA.filter(row =>
      Object.values(row).some(v => clean(v) === needle)
    );
  } else {
    const nlc = q.toLowerCase();
    results = DATA.filter(row =>
      Object.values(row).some(v => clean(v).toLowerCase().includes(nlc))
    );
  }

  render(results, q);
}

function renderWarn(msg){
  document.getElementById('out').innerHTML =
    `<div class="warn">${msg}</div>`;
}

function render(rows, q){
  const out = document.getElementById('out');
  if (!rows.length){
    renderWarn('Tidak ditemukan data yang sesuai');
    return;
  }
  let html = `<div class="count">ðŸ“Š Ditemukan ${rows.length} data:</div>`;
  rows.forEach(row=>{
    const keys = Object.keys(row);
    // cari field IDPEL
    const idpelKey = keys.find(k=>k.toUpperCase()==='IDPEL');
    const idpelVal = idpelKey ? clean(row[idpelKey]) : '';

    html += `<div class="card">`;
    if (idpelVal) html += `<div class="idpel">IDPEL: ${idpelVal}</div>`;

    html += `<div class="kv">`;
    keys.forEach(k=>{
      const val = clean(row[k]);
      if (val==='') return;
      if (/^https?:\/\//i.test(val)){
        html += `<div><b>${k}</b></div><div><a href="${val}" target="_blank" rel="noopener">Link</a></div>`;
      } else {
        html += `<div><b>${k}</b></div><div>${val}</div>`;
      }
    });

    // tambahkan link peta jika memungkinkan
    const maps = makeMapsLink(row);
    if (maps){
      html += `<div><b>PETA</b></div><div><a href="${maps}" target="_blank" rel="noopener">Lihat di Google Maps</a></div>`;
    }

    html += `</div></div>`;
  });
  out.innerHTML = html;
}

/* ---------- EVENTS ---------- */
document.getElementById('go').addEventListener('click', ()=>{
  search(document.getElementById('q').value);
});
document.getElementById('q').addEventListener('keypress', (e)=>{
  if (e.key==='Enter') search(e.target.value);
});
document.getElementById('btnRefresh').addEventListener('click', async ()=>{
  await loadAll();
  renderWarn('Database telah diperbarui. Silakan lakukan pencarian.');
});

/* initial */
loadAll().then(()=>renderWarn('Silakan ketik kata kunci lalu tekan Enter / klik Cari.'));
</script>
</body>
</html>
