<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>VKRN ULP Wonosobo</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    body { padding: 20px; background: #f8f9fa; }
    .result-table { margin-top: 20px; }
    footer { margin-top: 50px; text-align: center; font-size: 0.9em; color: #666; }
  </style>
</head>
<body>
  <div class="container">
    <h2 class="text-center mb-3">VKRN ULP Wonosobo</h2>
    <p class="text-center text-muted">
      Database terakhir diupdate: <span id="lastUpdate"></span>
    </p>
    <div class="text-center mb-3">
      <button class="btn btn-success" onclick="refreshData()">ðŸ”„ Refresh Database</button>
    </div>

    <div class="input-group mb-3">
      <input type="text" id="searchInput" class="form-control" placeholder="Masukkan IDPEL / Nomor Meter / Nama">
      <button class="btn btn-primary" onclick="searchData()">Cari</button>
    </div>

    <div id="result"></div>
  </div>

  <footer>
    @TELWBO<br> AHLINe PAK DAYAT
  </footer>

<script>
let allData = [];

// Fungsi parser CSV (mendukung koma, titik koma, tab)
function parseCSV(text) {
  if (text.charCodeAt(0) === 0xFEFF) text = text.slice(1); // strip BOM
  const firstLine = text.split(/\r?\n/)[0] || '';

  let delim = ',';
  const commaCount = firstLine.split(',').length;
  const tabCount = firstLine.split('\t').length;
  const semiCount = firstLine.split(';').length;
  if (semiCount > commaCount && semiCount > tabCount) delim = ';';
  else if (tabCount > commaCount) delim = '\t';

  const rows = [];
  let row = [], field = '', inQuotes = false, i = 0;
  while (i < text.length) {
    const c = text[i];
    if (inQuotes) {
      if (c === '"') {
        if (i + 1 < text.length && text[i + 1] === '"') { field += '"'; i += 2; }
        else { inQuotes = false; i++; }
      } else { field += c; i++; }
    } else {
      if (c === '"') { inQuotes = true; i++; }
      else if (c === delim) { row.push(field.trim()); field = ''; i++; }
      else if (c === '\n') { row.push(field.trim()); field = ''; if (row.some(v => v !== '')) rows.push(row); row = []; i++; }
      else if (c === '\r') { i++; }
      else { field += c; i++; }
    }
  }
  if (field.length || row.length) { row.push(field.trim()); if (row.some(v => v !== '')) rows.push(row); }
  return rows;
}

// Ambil dua file CSV: eksisting + sanxing
async function loadData() {
  allData = [];

  const files = ["vkm.csv", "vkm_sanxing.csv"];
  for (let file of files) {
    try {
      const resp = await fetch(file + "?t=" + Date.now());
      if (!resp.ok) continue;
      const text = await resp.text();
      const rows = parseCSV(text);
      if (rows.length > 1) {
        const headers = rows[0].map(h => h.toUpperCase());
        for (let i = 1; i < rows.length; i++) {
          if (!rows[i] || rows[i].length === 0) continue;
          let obj = {};
          for (let j = 0; j < headers.length; j++) {
            obj[headers[j]] = rows[i][j] || "";
          }
          allData.push(obj);
        }
      }
    } catch (e) {
      console.error("Gagal load", file, e);
    }
  }

  document.getElementById("lastUpdate").textContent =
    new Date().toLocaleString("id-ID");
}

function refreshData() {
  loadData().then(() => alert("Database berhasil di-refresh!"));
}

function searchData() {
  const q = document.getElementById("searchInput").value.trim().toUpperCase();
  const resultDiv = document.getElementById("result");
  resultDiv.innerHTML = "";

  if (!q) return;

  const results = allData.filter(row =>
    Object.values(row).some(v => (v || "").toUpperCase().includes(q))
  );

  if (results.length === 0) {
    resultDiv.innerHTML = `<div class="alert alert-warning">Tidak ditemukan data yang sesuai</div>`;
    return;
  }

  let html = `<p><b>ðŸ“Š Ditemukan ${results.length} data:</b></p>`;
  html += `<div class="table-responsive"><table class="table table-sm table-bordered result-table"><thead><tr>`;
  for (let key of Object.keys(results[0])) {
    html += `<th>${key}</th>`;
  }
  html += `</tr></thead><tbody>`;
  results.forEach(r => {
    html += `<tr>`;
    for (let val of Object.values(r)) {
      if (typeof val === "string" && val.startsWith("http")) {
        html += `<td><a href="${val}" target="_blank">Link</a></td>`;
      } else {
        html += `<td>${val}</td>`;
      }
    }
    html += `</tr>`;
  });
  html += `</tbody></table></div>`;
  resultDiv.innerHTML = html;
}

// load saat pertama
loadData();
</script>
</body>
</html>
