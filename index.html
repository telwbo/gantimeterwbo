<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VKRN ULP Wonosobo</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f8f9fa; }
    .container { max-width: 900px; margin: auto; padding: 30px; }
    h1 { text-align: center; margin-bottom: 20px; }
    .info { text-align: center; margin-bottom: 15px; color: #555; }
    .search-box { display: flex; justify-content: center; margin-bottom: 20px; }
    .search-box input { width: 70%; padding: 10px; border: 1px solid #ccc; border-radius: 5px 0 0 5px; }
    .search-box button { padding: 10px 20px; border: none; background: #3f51b5; color: white; border-radius: 0 5px 5px 0; cursor: pointer; }
    .search-box button:hover { background: #2c3e9f; }
    .results-count { margin-bottom: 10px; font-weight: bold; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; }
    th, td { border: 1px solid #ddd; padding: 8px; font-size: 14px; }
    th { background: #f1f1f1; text-align: left; }
    .no-results { padding: 15px; background: #fff3cd; border: 1px solid #ffeeba; border-radius: 5px; color: #856404; margin-top: 15px; }
    footer { text-align: center; margin-top: 30px; color: #888; font-size: 14px; }
    .btn-refresh { background: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; }
    .btn-refresh:hover { background: #218838; }
  </style>
</head>
<body>
  <div class="container">
    <h1>VKRN ULP Wonosobo</h1>
    <div class="info">
      Database terakhir diupdate: <span id="lastUpdate">-</span><br>
      <button class="btn-refresh" onclick="loadCSV()">ðŸ”„ Refresh Database</button>
    </div>

    <div class="search-box">
      <input type="text" id="searchInput" placeholder="Masukkan IDPEL / Nomor Meter / Nama">
      <button id="searchButton">Cari</button>
    </div>

    <div id="resultsContainer"></div>
  </div>

  <footer>
    @TELWBO<br> AHLINe PAK DAYAT
  </footer>

  <script>
    let csvData = [];

    function parseCSV(text) {
      if (text.charCodeAt(0) === 0xFEFF) text = text.slice(1);
      const firstLine = text.split(/\r?\n/)[0] || '';
      const delim = firstLine.includes(';') ? ';' : ',';
      const rows = text.split(/\r?\n/).map(r => r.split(delim).map(v => v.trim()));
      return rows.filter(r => r.some(v => v !== ''));
    }

    async function loadCSV() {
      try {
        const response = await fetch("vkrn.csv");
        const text = await response.text();
        const rows = parseCSV(text);
        if (!rows.length) return;

        const headers = rows[0];
        csvData = rows.slice(1).map(r => {
          const obj = {};
          headers.forEach((h, i) => { obj[h.trim()] = (r[i] || "").trim(); });
          return obj;
        });

        document.getElementById("lastUpdate").textContent = new Date().toLocaleString("id-ID");
        console.log("CSV loaded:", csvData.length);
      } catch (err) {
        console.error("Error load CSV:", err);
      }
    }

    function performSearch(keyword) {
      keyword = keyword.trim().toLowerCase();
      let results = [];

      if (/^\d+$/.test(keyword)) {
        results = csvData.filter(item =>
          Object.values(item).some(v => (v || "").trim() === keyword)
        );
      } else {
        results = csvData.filter(item =>
          Object.values(item).some(v => (v || "").toLowerCase().includes(keyword))
        );
      }

      displayResults(results);
    }

    function displayResults(results) {
      const container = document.getElementById("resultsContainer");
      if (!results.length) {
        container.innerHTML = '<div class="no-results">Tidak ditemukan data yang sesuai</div>';
        return;
      }

      let html = `<div class="results-count">ðŸ“Š Ditemukan ${results.length} data:</div>`;
      html += "<table><thead><tr>";
      Object.keys(results[0]).forEach(k => { html += `<th>${k}</th>`; });
      html += "</tr></thead><tbody>";

      results.forEach(item => {
        html += "<tr>";
        Object.entries(item).forEach(([k, v]) => {
          if (typeof v === "string" && v.startsWith("http")) {
            html += `<td><a href="${v}" target="_blank">Lihat Peta</a></td>`;
          } else {
            html += `<td>${v}</td>`;
          }
        });
        html += "</tr>";
      });
      html += "</tbody></table>";
      container.innerHTML = html;
    }

    document.getElementById("searchButton").addEventListener("click", () => {
      performSearch(document.getElementById("searchInput").value);
    });
    document.getElementById("searchInput").addEventListener("keypress", e => {
      if (e.key === "Enter") performSearch(document.getElementById("searchInput").value);
    });

    loadCSV();
  </script>
</body>
</html>
