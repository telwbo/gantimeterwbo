<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VKRN ULP Wonosobo</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        * { box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { margin: 0; padding: 20px; background-color: #f5f5f5; }
        .container { max-width: 100%; width: 100%; margin: 0 auto; background-color: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); }
        h1 { text-align: center; color: #2c3e50; margin-bottom: 30px; }
        .initialization-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8); display: flex; align-items: center; justify-content: center; z-index: 9999; }
        .initialization-content { background-color: white; padding: 40px; border-radius: 10px; text-align: center; max-width: 450px; width: 90%; }
        .init-spinner { width: 60px; height: 60px; border: 5px solid #ecf0f1; border-top: 5px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        .init-text { font-size: 18px; font-weight: bold; color: #2c3e50; margin-bottom: 10px; }
        .init-subtext { font-size: 14px; color: #7f8c8d; margin-bottom: 20px; }
        .progress-bar { width: 100%; height: 10px; background-color: #ecf0f1; border-radius: 5px; overflow: hidden; margin-bottom: 10px; }
        .progress-fill { height: 100%; background-color: #3498db; width: 0%; transition: width 0.3s ease; }
        .progress-text { font-size: 12px; color: #7f8c8d; }
        .first-time-notice { background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; padding: 15px; margin-bottom: 20px; font-size: 13px; color: #856404; }
        .search-container { display: flex; margin-bottom: 20px; max-width: 800px; margin-left: auto; margin-right: auto; }
        .search-container.hidden { display: none; }
        #searchInput { flex: 1; padding: 12px 15px; border: 1px solid #ddd; border-radius: 5px 0 0 5px; font-size: 16px; outline: none; }
        #searchInput:focus { border-color: #3498db; }
        #searchButton { padding: 12px 20px; background-color: #3498db; color: white; border: none; border-radius: 0 5px 5px 0; cursor: pointer; font-size: 16px; transition: background-color 0.2s; }
        #searchButton:hover { background-color: #2980b9; }
        .search-again-container { display: none; text-align: center; margin-bottom: 20px; }
        .search-again-container.show { display: block; }
        .search-again-btn { background-color: #e74c3c; color: white; border: none; padding: 12px 30px; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .search-again-btn:hover { background-color: #c0392b; transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        .system-status { background-color: #d4edda; border: 1px solid #c3e6cb; color: #155724; padding: 12px 15px; border-radius: 4px; margin-bottom: 20px; font-size: 14px; display: none; }
        .system-status.show { display: block; }
        .system-status.error { background-color: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        .system-status.cached { background-color: #d1ecf1; border-color: #bee5eb; color: #0c5460; }
        .database-controls { text-align: center; margin-bottom: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 4px; display: none; }
        .database-controls.show { display: block; }
        .database-info { font-size: 13px; color: #6c757d; margin-bottom: 10px; }
        .refresh-db-btn.green { background-color: #27ae60 !important; animation: none !important; }
        .refresh-db-btn.red-blink { background-color: #e74c3c !important; animation: blink-red 1s infinite; }
        @keyframes blink-red { 0% { background-color: #e74c3c; } 50% { background-color: #fff; color: #e74c3c; } 100% { background-color: #e74c3c; } }
        .refresh-db-btn { color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-size: 12px; transition: background-color 0.2s; }
        .refresh-db-btn:hover { background-color: #545b62; }
        #resultsContainer { margin-top: 20px; margin-bottom: 30px; }
        .result-item { padding: 15px; border: 1px solid #eee; border-radius: 8px; margin-bottom: 15px; background-color: #fafafa; display: inline-block; width: calc(50% - 10px); margin-right: 20px; vertical-align: top; }
        .result-item:nth-child(even) { margin-right: 0; }
        .result-item p { margin: 5px 0; word-wrap: break-word; font-size: 14px; }
        .result-item strong { color: #2c3e50; }
        .result-item .idpel { background-color: #e8f6ff; padding: 8px; border-radius: 4px; border-left: 3px solid #3498db; margin: 10px 0; font-weight: bold; }
        .no-results { text-align: center; color: #7f8c8d; padding: 20px; }
        .show-program-btn { background-color: #27ae60; color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-size: 13px; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-top: 10px; width: 100%; }
        .show-program-btn:hover { background-color: #229954; transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        .show-program-btn.instant { background-color: #f39c12; position: relative; }
        .show-program-btn.instant:hover { background-color: #d68910; }
        .show-program-btn.instant::after { content: "‚ö°"; position: absolute; top: 2px; right: 5px; font-size: 12px; }
        #pdfContainer { display: none; margin-top: 30px; border-top: 2px solid #34495e; padding-top: 30px; }
        .pdf-viewer { background-color: white; text-align: center; padding: 0; }
        .pdf-page { margin-bottom: 20px; position: relative; display: inline-block; box-shadow: 0 4px 8px rgba(0,0,0,0.1); border-radius: 4px; overflow: hidden; }
        .pdf-canvas { width: 100%; height: auto; display: block; image-rendering: -webkit-optimize-contrast; image-rendering: crisp-edges; image-rendering: pixelated; }
        .highlight-overlay { position: absolute; background-color: rgba(255, 255, 0, 0.4); border: 2px solid #ffeb3b; border-radius: 3px; pointer-events: none; animation: blink 1.5s ease-in-out 3; }
        @keyframes blink { 0%, 100% { opacity: 0.4; } 50% { opacity: 0.8; } }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .results-count { margin-bottom: 15px; color: #7f8c8d; font-size: 14px; font-weight: bold; }
        @media (max-width: 768px) {
            .container { padding: 15px; }
            .result-item { width: 100%; margin-right: 0; }
            .initialization-content { padding: 30px 20px; }
            .search-container { max-width: 100%; margin-bottom: 20px; }
        }
    </style>
</head>
<body>
    <div class="initialization-overlay" id="initOverlay">
        <div class="initialization-content">
            <div class="init-spinner"></div>
            <div class="init-text" id="initTitle">Memuat Sistem Pencarian</div>
            <div class="init-subtext" id="initSubtext">Mohon tunggu...</div>
            <div class="first-time-notice" id="firstTimeNotice" style="display: none;">
                üìù <strong>Informasi:</strong> Ini adalah kunjungan pertama Anda. Sistem sedang membangun database lokal untuk pencarian yang lebih cepat di kunjungan selanjutnya.
            </div>
            <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
            <div class="progress-text" id="progressText">0% - Memuat...</div>
        </div>
    </div>

    <div class="container">
        <h1>VKRN ULP Wonosobo</h1>

        <div class="system-status" id="systemStatus">‚úÖ Sistem siap!</div>

        <div class="database-controls" id="databaseControls">
            <div class="database-info" id="databaseInfo">Database terakhir diupdate: <span id="lastUpdate">-</span></div>
            <button class="refresh-db-btn" id="refreshDbBtn" onclick="refreshDatabase()">üîÑ Refresh Database</button>
        </div>

        <div class="search-container" id="searchContainer">
            <input type="text" id="searchInput" placeholder="Masukkan pencarian...">
            <button id="searchButton">Cari</button>
        </div>

        <div class="search-again-container" id="searchAgainContainer">
            <button class="search-again-btn" id="searchAgainBtn">üîç Cari Lagi</button>
        </div>

        <div id="resultsContainer"></div>

        <div id="pdfContainer">
            <div class="pdf-viewer" id="pdfViewer"></div>
        </div>
    </div>

    <script>
        // ===== Variabel global =====
        let csvData = [];
        let currentPdf = null;
        let searchIdpel = '';
        let foundPages = [];
        let devicePixelRatio = window.devicePixelRatio || 1;
        let hasSearchResults = false;
        let isSystemReady = false;

        // Database lokal (IndexedDB)
        let db = null;
        let textIndex = new Map();
        let pdfDatabase = new Map();

        const DATABASE_NAME = 'VKRNPDFDatabase';
        const DATABASE_VERSION = 2;
        const DATABASE_STORE_NAME = 'pdfTextIndex';
        const DATABASE_EXPIRY_DAYS = 30;

        const availablePDFs = [
            { file: 'pdf/CR_PK_TOKEN_LPB_kolektif-KRN KEJAJAR.pdf', name: 'CR PK TOKEN LPB Kolektif KRN KEJAJAR', id: 'pdf1' },
            { file: 'pdf/KRN KEJAJAR.pdf', name: 'KRN KEJAJAR', id: 'pdf2' },
            { file: 'pdf/KRN KEJAJAR160824.PDF', name: 'KRN KEJAJAR 160824', id: 'pdf3' },
            { file: 'pdf/TOKEN JAMAL 160824.pdf', name: 'TOKEN JAMAL 160824', id: 'pdf4' }
        ];

        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // ===== DB helpers =====
        function openDatabase() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DATABASE_NAME, DATABASE_VERSION);
                request.onerror = () => reject(request.error);
                request.onsuccess = (e) => { db = e.target.result; resolve(db); };
                request.onupgradeneeded = (e) => {
                    const database = e.target.result;
                    if (database.objectStoreNames.contains(DATABASE_STORE_NAME)) {
                        database.deleteObjectStore(DATABASE_STORE_NAME);
                    }
                    const store = database.createObjectStore(DATABASE_STORE_NAME, { keyPath: 'id', autoIncrement: true });
                    store.createIndex('pdfId', 'pdfId', { unique: false });
                    store.createIndex('pageNumber', 'pageNumber', { unique: false });
                    store.createIndex('searchText', 'searchText', { unique: false });
                };
            });
        }

        function setRefreshDbButtonState(state) {
            const btn = document.getElementById('refreshDbBtn');
            if (!btn) return;
            btn.classList.remove('green', 'red-blink');
            if (state === 'green') btn.classList.add('green');
            else if (state === 'red-blink') btn.classList.add('red-blink');
        }

        async function saveIndexToDatabase(indexData) {
            return new Promise((resolve, reject) => {
                if (!db) return reject(new Error('Database not initialized'));
                const tx = db.transaction([DATABASE_STORE_NAME], 'readwrite');
                const store = tx.objectStore(DATABASE_STORE_NAME);

                const clearReq = store.clear();
                clearReq.onsuccess = () => {
                    store.add({ type: 'metadata', timestamp: Date.now(), version: DATABASE_VERSION, totalPDFs: availablePDFs.length, totalPages: indexData.size });
                    const promises = [];
                    for (const [key, value] of indexData.entries()) {
                        const req = store.add({
                            type: 'index',
                            indexKey: key,
                            pdfId: value.pdfId,
                            pdfInfo: value.pdfInfo,
                            pageNumber: value.pageNumber,
                            searchText: value.text,
                            originalText: value.originalText
                        });
                        promises.push(new Promise(r => req.onsuccess = r));
                    }
                    Promise.all(promises).then(() => resolve());
                };
                clearReq.onerror = () => reject(clearReq.error);
            });
        }

        async function loadIndexFromDatabase() {
            return new Promise((resolve, reject) => {
                if (!db) return reject(new Error('Database not initialized'));
                const tx = db.transaction([DATABASE_STORE_NAME], 'readonly');
                const store = tx.objectStore(DATABASE_STORE_NAME);
                const getAll = store.getAll();
                getAll.onsuccess = () => {
                    const all = getAll.result;
                    const metadata = all.find(x => x.type === 'metadata');
                    if (!metadata) return resolve(false);
                    const age = Date.now() - metadata.timestamp;
                    const maxAge = DATABASE_EXPIRY_DAYS * 24 * 60 * 60 * 1000;
                    if (age > maxAge) return resolve(false);

                    const indexRows = all.filter(x => x.type === 'index');
                    textIndex.clear();
                    for (const item of indexRows) {
                        textIndex.set(item.indexKey, {
                            pdfId: item.pdfId,
                            pdfInfo: item.pdfInfo,
                            pageNumber: item.pageNumber,
                            text: item.searchText,
                            originalText: item.originalText
                        });
                    }
                    updateDatabaseInfo(metadata.timestamp);
                    resolve(true);
                };
                getAll.onerror = () => reject(getAll.error);
            });
        }

        function updateProgress(percentage, text) {
            document.getElementById('progressFill').style.width = percentage + '%';
            document.getElementById('progressText').textContent = `${percentage}% - ${text}`;
        }

        function updateDatabaseInfo(timestamp) {
            const lastUpdateElement = document.getElementById('lastUpdate');
            const databaseControlsElement = document.getElementById('databaseControls');
            if (timestamp) {
                const date = new Date(timestamp);
                lastUpdateElement.textContent = date.toLocaleString('id-ID');
                databaseControlsElement.classList.add('show');
            }
        }

        function showSystemStatus(message, type = 'success') {
            const systemStatus = document.getElementById('systemStatus');
            systemStatus.textContent = message;
            systemStatus.className = 'system-status show';
            if (type === 'error') systemStatus.classList.add('error');
            else if (type === 'cached') systemStatus.classList.add('cached');
            if (type !== 'error') setTimeout(() => systemStatus.classList.remove('show'), 5000);
        }

        // ===== Inisialisasi =====
        async function initializeSystem() {
            try {
                updateProgress(5, 'Membuka database lokal...');
                await openDatabase();

                updateProgress(10, 'Memeriksa database lokal...');
                const hasValidCache = await loadIndexFromDatabase();

                if (hasValidCache) {
                    setRefreshDbButtonState('green');
                    document.getElementById('initTitle').textContent = 'Memuat dari Database Lokal';
                    document.getElementById('initSubtext').textContent = 'Menggunakan data yang sudah tersimpan...';

                    updateProgress(50, 'Memuat data CSV...');
                    await loadCSVData();

                    updateProgress(90, 'Mempersiapkan sistem...');
                    await new Promise(r => setTimeout(r, 500));
                    updateProgress(100, 'Sistem siap!');
                    setTimeout(() => {
                        document.getElementById('initOverlay').style.display = 'none';
                        isSystemReady = true;
                        showSystemStatus(`‚ö° Sistem siap! Menggunakan database lokal dengan ${textIndex.size} entri pencarian.`, 'cached');
                    }, 1000);
                } else {
                    setRefreshDbButtonState('red-blink');
                    document.getElementById('firstTimeNotice').style.display = 'block';
                    document.getElementById('initTitle').textContent = 'Membangun Database Lokal';
                    document.getElementById('initSubtext').textContent = 'Proses indexing otomatis, mohon tunggu...';
                    document.getElementById('progressFill').style.width = '0%';
                    document.getElementById('progressText').textContent = 'Memulai indexing otomatis...';
                    isSystemReady = false;
                    await performFullIndexing();
                }
            } catch (error) {
                console.error('Error during initialization:', error);
                updateProgress(100, 'Error inisialisasi');
                setTimeout(() => {
                    document.getElementById('initOverlay').style.display = 'none';
                    showSystemStatus('‚ùå Terjadi error saat inisialisasi. Beberapa fitur mungkin tidak berfungsi optimal.', 'error');
                }, 2000);
            }
        }

        async function performFullIndexing() {
            updateProgress(15, 'Memuat data CSV...');
            await loadCSVData();

            const progressPerPDF = 75 / availablePDFs.length;
            for (let i = 0; i < availablePDFs.length; i++) {
                const pdfInfo = availablePDFs[i];
                updateProgress(20 + (i * progressPerPDF), `Memuat dan mengindex ${pdfInfo.name}...`);
                try {
                    const loadingTask = pdfjsLib.getDocument(pdfInfo.file);
                    const pdf = await loadingTask.promise;
                    pdfDatabase.set(pdfInfo.id, { pdf, info: pdfInfo, totalPages: pdf.numPages });
                    await indexPDFText(pdf, pdfInfo);
                    updateProgress(20 + ((i + 1) * progressPerPDF), `Selesai mengindex ${pdfInfo.name}`);
                } catch (e) {
                    console.error(`Error loading ${pdfInfo.file}:`, e);
                }
            }

            updateProgress(95, 'Menyimpan ke database lokal...');
            await saveIndexToDatabase(textIndex);
            updateDatabaseInfo(Date.now());
            updateProgress(100, 'Sistem siap!');
            setTimeout(() => {
                document.getElementById('initOverlay').style.display = 'none';
                isSystemReady = true;
                setRefreshDbButtonState('green');
                showSystemStatus(`‚úÖ Sistem siap! Database lokal berisi ${textIndex.size} entri pencarian dari ${availablePDFs.length} file PDF.`);
            }, 1000);
        }

        async function indexPDFText(pdf, pdfInfo) {
            const total = pdf.numPages;
            for (let pageNum = 1; pageNum <= total; pageNum++) {
                try {
                    const page = await pdf.getPage(pageNum);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');

                    const indexKey = `${pdfInfo.id}_page_${pageNum}`;
                    textIndex.set(indexKey, {
                        pdfId: pdfInfo.id,
                        pdfInfo,
                        pageNumber: pageNum,
                        text: pageText.toLowerCase(),
                        originalText: pageText,
                        textItems: textContent.items
                    });
                } catch (e) {
                    console.error(`Error indexing page ${pageNum} of ${pdfInfo.name}:`, e);
                }
            }
        }

        async function refreshDatabase() {
            if (!confirm('Apakah Anda yakin ingin me-refresh database? Proses ini akan memakan waktu beberapa menit.')) return;
            document.getElementById('initOverlay').style.display = 'flex';
            document.getElementById('initTitle').textContent = 'Me-refresh Database';
            document.getElementById('initSubtext').textContent = 'Membangun ulang database lokal...';
            document.getElementById('firstTimeNotice').style.display = 'none';
            isSystemReady = false;
            textIndex.clear();
            pdfDatabase.clear();
            await performFullIndexing();
        }

        function instantSearch(searchTerm) {
            const results = [];
            const q = searchTerm.toLowerCase();
            for (const [, entry] of textIndex.entries()) {
                if (entry.text.includes(q)) results.push(entry);
            }
            return results;
        }

        // ===== CSV PARSER (auto delimiter) & loader =====
        function parseCSV(text) {
            if (text.charCodeAt(0) === 0xFEFF) text = text.slice(1); // strip BOM
            const firstLine = text.split(/\r?\n/)[0] || '';
            const delim = (firstLine.split('\t').length > firstLine.split(',').length) ? '\t' : ',';

            const rows = [];
            let row = [], field = '', inQuotes = false, i = 0;

            while (i < text.length) {
                const c = text[i];
                if (inQuotes) {
                    if (c === '"') {
                        if (i + 1 < text.length && text[i + 1] === '"') { field += '"'; i += 2; }
                        else { inQuotes = false; i++; }
                    } else { field += c; i++; }
                } else {
                    if (c === '"') { inQuotes = true; i++; }
                    else if (c === delim) { row.push(field.trim()); field = ''; i++; }
                    else if (c === '\n') {
                        row.push(field.trim()); field = '';
                        if (row.some(v => v !== '')) rows.push(row);
                        row = []; i++;
                    } else if (c === '\r') { i++; }
                    else { field += c; i++; }
                }
            }
            if (field.length || row.length) { row.push(field.trim()); if (row.some(v => v !== '')) rows.push(row); }
            return { rows, delim };
        }

        async function loadCSVData() {
            try {
                const response = await fetch('vkrn.csv');
                const csvText = await response.text();

                const { rows } = parseCSV(csvText);
                if (!rows.length) { csvData = []; return; }

                const headers = rows[0].map(h => h.trim());
                const objects = [];
                for (let r = 1; r < rows.length; r++) {
                    const line = rows[r];
                    if (!line || !line.length) continue;
                    const obj = {};
                    for (let j = 0; j < headers.length; j++) {
                        const key = headers[j] || `COL_${j+1}`;
                        obj[key] = (line[j] ?? '').toString().trim();
                    }
                    const allEmpty = Object.values(obj).every(v => v === '');
                    if (!allEmpty) objects.push(obj);
                }
                csvData = objects;
                console.log('Data CSV dimuat:', csvData.length, 'records');
            } catch (error) {
                console.error('Gagal memuat file CSV:', error);
                throw error;
            }
        }

        // ===== UI helpers =====
        function toggleSearchDisplay(showResults = false) {
            const searchContainer = document.getElementById('searchContainer');
            const searchAgainContainer = document.getElementById('searchAgainContainer');
            if (showResults) { searchContainer.classList.add('hidden'); searchAgainContainer.classList.add('show'); hasSearchResults = true; }
            else { searchContainer.classList.remove('hidden'); searchAgainContainer.classList.remove('show'); hasSearchResults = false; }
        }

        function searchAgain() {
            searchIdpel = ''; foundPages = []; currentPdf = null; hasSearchResults = false;
            document.getElementById('searchInput').value = '';
            document.getElementById('resultsContainer').innerHTML = '';
            document.getElementById('pdfContainer').style.display = 'none';
            document.getElementById('pdfViewer').innerHTML = '';
            toggleSearchDisplay(false);
            document.getElementById('searchInput').focus();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function performSearch(keyword) {
            if (keyword.trim() === "") { alert('Silakan masukkan kata kunci pencarian'); return; }
            if (!isSystemReady) { alert('Sistem masih dalam proses inisialisasi. Mohon tunggu sebentar...'); return; }
            document.getElementById('searchInput').value = '';
            document.getElementById('searchInput').blur();

            const q = keyword.toLowerCase();
            const results = csvData.filter(item => Object.keys(item).some(k => (item[k]||'').toLowerCase().includes(q)));
            displayResults(results);
            if (results.length > 0) toggleSearchDisplay(true);
        }

        // ===== Display results (auto link peta & URL) =====
        function displayResults(results) {
            const resultsContainer = document.getElementById('resultsContainer');
            if (!results.length) {
                resultsContainer.innerHTML = '<div class="no-results">Tidak ditemukan data yang sesuai</div>';
                document.getElementById('pdfContainer').style.display = 'none';
                return;
            }

            let html = `<div class="results-count">üìä Ditemukan ${results.length} data:</div>`;

            results.forEach(item => {
                const idpelKey = Object.keys(item).find(k => k.toLowerCase() === 'idpel');
                const idpelVal = idpelKey ? (item[idpelKey] || '').trim() : '';

                const kxKey = Object.keys(item).find(k => k.toLowerCase().includes('koordinat_x'));
                const kyKey = Object.keys(item).find(k => k.toLowerCase().includes('koordinat_y'));
                const kx = kxKey ? item[kxKey] : '';
                const ky = kyKey ? item[kyKey] : '';
                const hasCoord = kx && ky && !isNaN(Number(kx)) && !isNaN(Number(ky));
                const mapsUrl = hasCoord ? `https://www.google.com/maps?q=${kx},${ky}` : '';

                html += '<div class="result-item">';

                for (const key of Object.keys(item)) {
                    const val = item[key] ?? '';
                    if (idpelKey && key === idpelKey) {
                        html += `<div class="idpel"><strong>${key}:</strong> ${val}</div>`;
                    } else if (typeof val === 'string' && /^https?:\/\//i.test(val)) {
                        html += `<p><strong>${key}:</strong> <a href="${val}" target="_blank" rel="noopener">Link</a></p>`;
                    } else {
                        html += `<p><strong>${key}:</strong> ${val}</p>`;
                    }
                }

                if (hasCoord) {
                    html += `<p><strong>PETA:</strong> <a href="${mapsUrl}" target="_blank" rel="noopener">Lihat Peta</a></p>`;
                }

                if (idpelVal) {
                    html += `<button class="show-program-btn instant" onclick="showProgram('${idpelVal}')">
                        üìÑ Tampilkan Program<br>IDPEL: ${idpelVal}
                    </button>`;
                }

                html += '</div>';
            });

            resultsContainer.innerHTML = html;
        }

        // ===== PDF rendering =====
        async function showProgram(idpel) {
            const pdfContainer = document.getElementById('pdfContainer');
            const pdfViewer = document.getElementById('pdfViewer');
            if (!isSystemReady) { alert('Sistem masih dalam proses inisialisasi. Mohon tunggu sebentar...'); return; }

            searchIdpel = idpel;
            pdfContainer.style.display = 'block';
            pdfContainer.scrollIntoView({ behavior: 'smooth' });

            const searchResults = instantSearch(idpel);
            if (!searchResults.length) {
                pdfViewer.innerHTML = `<div class="error-message">üîç IDPEL "${idpel}" tidak ditemukan dalam database PDF</div>`;
                return;
            }
            pdfViewer.innerHTML = '<div style="text-align: center; padding: 20px; color: #7f8c8d;">‚ö° Memuat hasil pencarian instan...</div>';
            await renderFoundPages(searchResults);
        }

        async function renderFoundPages(searchResults) {
            const pdfViewer = document.getElementById('pdfViewer');
            pdfViewer.innerHTML = '';

            const grouped = new Map();
            for (const r of searchResults) {
                if (!grouped.has(r.pdfId)) grouped.set(r.pdfId, []);
                grouped.get(r.pdfId).push(r);
            }

            for (const [pdfId, pages] of grouped.entries()) {
                let pdfData = pdfDatabase.get(pdfId);
                if (!pdfData) {
                    const pdfInfo = availablePDFs.find(p => p.id === pdfId);
                    if (pdfInfo) {
                        try {
                            const loadingTask = pdfjsLib.getDocument(pdfInfo.file);
                            const pdf = await loadingTask.promise;
                            pdfData = { pdf, info: pdfInfo, totalPages: pdf.numPages };
                            pdfDatabase.set(pdfId, pdfData);
                        } catch (e) {
                            console.error(`Error loading PDF ${pdfInfo.file}:`, e);
                            continue;
                        }
                    }
                }
                if (!pdfData) continue;

                for (const pageResult of pages) {
                    try {
                        const page = await pdfData.pdf.getPage(pageResult.pageNumber);
                        const containerWidth = pdfViewer.clientWidth - 40;
                        const baseViewport = page.getViewport({ scale: 1 });
                        const scale = containerWidth / baseViewport.width;

                        const canvas = await renderPageToCanvas(page, scale);
                        const pageDiv = document.createElement('div');
                        pageDiv.className = 'pdf-page';
                        pageDiv.appendChild(canvas);
                        await highlightTextInPage(page, pageDiv, page.getViewport({ scale }), searchIdpel);
                        pdfViewer.appendChild(pageDiv);
                    } catch (e) {
                        console.error(`Error rendering page ${pageResult.pageNumber}:`, e);
                    }
                }
            }
        }

        async function renderPageToCanvas(page, scale) {
            const viewport = page.getViewport({ scale });
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');

            const outputScale = devicePixelRatio;
            canvas.width = Math.floor(viewport.width * outputScale);
            canvas.height = Math.floor(viewport.height * outputScale);
            canvas.style.width = Math.floor(viewport.width) + "px";
            canvas.style.height = Math.floor(viewport.height) + "px";
            const transform = outputScale !== 1 ? [outputScale, 0, 0, outputScale, 0, 0] : null;

            context.imageSmoothingEnabled = true;
            context.imageSmoothingQuality = 'high';
            canvas.className = 'pdf-canvas';

            const renderContext = { canvasContext: context, viewport, transform };
            await page.render(renderContext).promise;
            return canvas;
        }

        async function highlightTextInPage(page, pageDiv, viewport, searchText) {
            try {
                const textContent = await page.getTextContent();
                textContent.items.forEach(item => {
                    if (item.str.toLowerCase().includes(searchText.toLowerCase())) {
                        const highlight = document.createElement('div');
                        highlight.className = 'highlight-overlay';
                        const transform = pdfjsLib.Util.transform(viewport.transform, item.transform);
                        const left = transform[4];
                        const top = viewport.height - transform[5] - item.height;
                        highlight.style.left = left + 'px';
                        highlight.style.top = top + 'px';
                        highlight.style.width = item.width + 'px';
                        highlight.style.height = item.height + 'px';
                        pageDiv.appendChild(highlight);
                    }
                });
            } catch (e) { console.error('Error highlighting text:', e); }
        }

        // ===== Events =====
        document.addEventListener('DOMContentLoaded', () => {
            initializeSystem();

            document.getElementById('searchButton').addEventListener('click', () => {
                const keyword = document.getElementById('searchInput').value;
                performSearch(keyword);
            });

            document.getElementById('searchInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    const keyword = document.getElementById('searchInput').value;
                    performSearch(keyword);
                }
            });

            document.getElementById('searchAgainBtn').addEventListener('click', searchAgain);
        });
    </script>

    <footer style="text-align:center; color:#888; padding:20px 0 0 0; font-size:14px;">
      @TELWBO<br> AHLINE PAK DAYAT
    </footer>
</body>
</html>
