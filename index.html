<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>VKRN ULP Wonosobo</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#f8f9fa;margin:0;padding:0}
    header{text-align:center;padding:20px}
    h1{margin:0;color:#222}
    .container{max-width:960px;margin:auto;padding:20px}
    #searchBox{width:100%;padding:10px;border:1px solid #ccc;border-radius:6px;font-size:16px}
    #resultsContainer{margin-top:20px}
    .card{background:#fff;border:1px solid #ddd;border-radius:8px;padding:16px;margin-top:14px}
    .card h4{margin-top:0}
    .btn{padding:10px 16px;border:0;border-radius:6px;cursor:pointer}
    .btn-primary{background:#2f7ce0;color:#fff}
    .btn-refresh{background:#28a745;color:#fff;margin-top:10px}
    .statusMsg{margin-left:10px;font-size:13px}
    .grid{display:grid;grid-template-columns:150px 180px 200px 1fr;gap:10px}
    .input{padding:10px;border:1px solid #ddd;border-radius:6px;font-size:14px;width:100%}
    @media(max-width:720px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header>
    <h1>VKRN ULP Wonosobo</h1>
    <p>Database terakhir diupdate: <span id="lastUpdate"></span></p>
    <button class="btn btn-refresh" onclick="refreshDb()">ðŸ”„ Refresh Database</button>
  </header>

  <div class="container">
    <input id="searchBox" type="text" placeholder="Cari IDPEL / Nama / Nomor meter..." onkeypress="if(event.key==='Enter'){doSearch();}" />
    <button class="btn btn-primary" style="margin-top:10px" onclick="doSearch()">Cari</button>
    <div id="resultsContainer"></div>
  </div>

  <script>
    // ========= KONFIGURASI =========
    const CSV_KRN = "vkrn.csv";              // CSV lama
    const CSV_SANXING = "vkrn_sanxing.csv";  // CSV baru
    const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbwBRqq6wiOCXYlLXCwMPOf-wKFQG2v8SAM6M5QH20JytJ199MPGSiu6L19tYuNoUML0/exec";
    const API_KEY = "VKRN_SECRET"; // samakan dgn Apps Script

    let allData = [];
    let lastUpdate = new Date().toLocaleString("id-ID");

    document.getElementById("lastUpdate").innerText = lastUpdate;

    async function loadCSVs(){
      const [krn, sanxing] = await Promise.all([fetch(CSV_KRN), fetch(CSV_SANXING)]);
      const text1 = await krn.text();
      const text2 = await sanxing.text();
      const rows1 = parseCSV(text1,",");
      const rows2 = parseCSV(text2,";");
      allData = [...rows1,...rows2];
    }

    function parseCSV(text,sep){
      const lines=text.trim().split(/\r?\n/);
      const headers=lines[0].split(sep);
      return lines.slice(1).map(line=>{
        const cols=line.split(sep);
        const obj={};
        headers.forEach((h,i)=>obj[h.trim()]=cols[i]?cols[i].trim():"");
        return obj;
      });
    }

    async function doSearch(){
      const q=document.getElementById("searchBox").value.trim().toLowerCase();
      const cont=document.getElementById("resultsContainer");
      cont.innerHTML="";
      if(!q) return;
      if(allData.length===0) await loadCSVs();
      const hasil=allData.filter(r=>
        (r.IDPEL||"").toLowerCase().includes(q) ||
        (r.NAMA||"").toLowerCase().includes(q) ||
        (r.NOMOR_METER_KWH||r.NOMOR_METER_LAMA||"").toLowerCase().includes(q)
      );
      if(hasil.length===0){cont.innerHTML="<p>Tidak ditemukan data yang sesuai</p>";return;}
      hasil.forEach(r=>renderCard(r,cont));
    }

    function renderCard(data,cont){
      const card=document.createElement("div");
      card.className="card";
      let html=`<h4 class="idpel">IDPEL: ${data.IDPEL||""}</h4>`;
      for(const k in data){
        html+=`<div><b>${k}</b>: ${data[k]}</div>`;
      }
      // Form input tegangan
      html+=`
      <hr>
      <h4>Input Tegangan (langsung di sini)</h4>
      <div class="grid">
        <input id="tegangan" type="number" placeholder="Tegangan (Volt)" class="input" />
        <select id="petugas" class="input">
          <option value="">Pilih Petugas</option>
          <option value="YUSUF">YUSUF</option>
          <option value="INGGIT">INGGIT</option>
          <option value="FARIS">FARIS</option>
        </select>
        <input id="nohp" type="tel" placeholder="Nomor HP pelanggan" class="input" />
        <input id="catatan" type="text" placeholder="Catatan (opsional)" class="input" />
      </div>
      <div style="margin-top:12px;display:flex;gap:10px;align-items:center;">
        <button class="btn btn-primary" onclick="simpanLog('${data.IDPEL||""}')">Simpan</button>
        <small id="statusMsg" class="statusMsg"></small>
      </div>`;
      card.innerHTML=html;
      cont.appendChild(card);
    }

    function normalizePhone(raw){
      const d=(raw||"").replace(/\D/g,"");
      if(!d) return "";
      if(d.startsWith("62")) return d;
      if(d.startsWith("0")) return "62"+d.slice(1);
      return d;
    }

    async function simpanLog(idpel){
      const tegangan=Number(document.getElementById("tegangan").value||0);
      const petugas=(document.getElementById("petugas").value||"").trim();
      const nohpRaw=document.getElementById("nohp").value||"";
      const nohp=normalizePhone(nohpRaw);
      const catatan=document.getElementById("catatan").value||"";
      const statusEl=document.getElementById("statusMsg");

      if(!idpel){alert("IDPEL kosong");return;}
      if(!tegangan){alert("Tegangan wajib");return;}
      if(!petugas){alert("Petugas wajib");return;}
      if(tegangan<220 && !nohp){alert("Nomor HP wajib jika tegangan <220V");return;}

      statusEl.textContent="Menyimpan...";
      statusEl.style.color="#6c757d";

      try{
        const body=new URLSearchParams({
          idpel,tegangan,petugas,nohp,catatan,api_key:API_KEY
        });
        const res=await fetch(GAS_ENDPOINT,{method:"POST",body});
        const data=await res.json();
        if(data.ok){
          statusEl.textContent="Tersimpan ("+new Date().toLocaleString("id-ID")+")";
          statusEl.style.color="#2e7d32";
        }else{
          statusEl.textContent="Gagal: "+(data.error||"unknown");
          statusEl.style.color="#c62828";
        }
      }catch(err){
        statusEl.textContent="Error koneksi: "+err;
        statusEl.style.color="#c62828";
      }
    }

    function refreshDb(){
      allData=[];
      document.getElementById("resultsContainer").innerHTML="";
      document.getElementById("lastUpdate").innerText=new Date().toLocaleString("id-ID");
    }
  </script>
</body>
</html>
