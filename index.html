<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pencarian Data VKRN</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        /* ...[Tetap gunakan style lama di sini, tidak ada perubahan]... */
        /* Gunakan style dari versi Anda sebelumnya */
    </style>
</head>
<body>
    <!-- Overlay inisialisasi -->
    <div class="initialization-overlay" id="initOverlay" style="display:none">
        <div class="initialization-content">
            <div class="init-spinner"></div>
            <div class="init-text">Memuat Sistem Pencarian</div>
            <div class="init-subtext">Sedang mengindex semua file PDF untuk pencarian yang lebih cepat...</div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">0% - Memuat...</div>
        </div>
    </div>

    <div class="container">
        <h1 style="margin-bottom:10px;">Pencarian Data VKRN</h1>
        <!-- Tombol refresh index di atas kolom pencarian -->
        <button id="refreshIndexBtn" style="
            display:inline-block;
            background:#3498db;
            color:white;
            border:none;
            border-radius:50%;
            width:45px;height:45px;
            font-size:25px;
            cursor:pointer;
            margin-bottom:15px;
            box-shadow:0 2px 6px rgba(0,0,0,0.1);
            " title="Refresh Index">üîÑ</button>
        <span style="margin-left:10px;color:#7f8c8d;font-size:15px;">Klik untuk memulai indexing data</span>
        
        <!-- Status sistem -->
        <div class="system-status show error" id="systemStatus">
            ‚ö†Ô∏è Sistem belum di-index. Klik tombol üîÑ untuk memulai indexing data.
        </div>
        
        <!-- Container pencarian awal -->
        <div class="search-container" id="searchContainer">
            <input type="text" id="searchInput" placeholder="Masukkan kata kunci pencarian...">
            <button id="searchButton">Cari</button>
        </div>
        
        <!-- Container cari lagi -->
        <div class="search-again-container" id="searchAgainContainer">
            <button class="search-again-btn" id="searchAgainBtn">üîç Cari Lagi</button>
        </div>
        
        <div id="resultsContainer"></div>
        <div id="pdfContainer">
            <div class="pdf-viewer" id="pdfViewer"></div>
        </div>
    </div>

    <script>
        // Variabel global
        let csvData = [];
        let currentPdf = null;
        let searchIdpel = '';
        let foundPages = [];
        let devicePixelRatio = window.devicePixelRatio || 1;
        let hasSearchResults = false;
        
        // Database offline untuk pencarian cepat
        let pdfDatabase = new Map(); // Menyimpan objek PDF yang sudah dimuat
        let textIndex = new Map(); // Index teks dari semua PDF
        let pageCache = new Map(); // Cache halaman yang sudah di-render
        let isSystemReady = false;
        
        // Daftar file PDF yang tersedia
        const availablePDFs = [
            { file: 'pdf/CR_PK_TOKEN_LPB_kolektif-KRN KEJAJAR.pdf', name: 'CR PK TOKEN LPB Kolektif KRN KEJAJAR', id: 'pdf1' },
            { file: 'pdf/KRN KEJAJAR.pdf', name: 'KRN KEJAJAR', id: 'pdf2' },
            { file: 'pdf/KRN KEJAJAR160824.PDF', name: 'KRN KEJAJAR 160824', id: 'pdf3' },
            { file: 'pdf/TOKEN JAMAL 160824.pdf', name: 'TOKEN JAMAL 160824', id: 'pdf4' }
        ];
        
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        
        function updateProgress(percentage, text) {
            document.getElementById('progressFill').style.width = percentage + '%';
            document.getElementById('progressText').textContent = `${percentage}% - ${text}`;
        }
        
        function showSystemStatus(message, isError = false) {
            const systemStatus = document.getElementById('systemStatus');
            systemStatus.textContent = message;
            systemStatus.className = isError ? 'system-status show error' : 'system-status show';
            if (!isError) {
                setTimeout(() => { systemStatus.classList.remove('show'); }, 5000);
            }
        }
        
        async function initializeSystem() {
            document.getElementById('initOverlay').style.display = 'flex';
            updateProgress(5, 'Memuat data CSV...');
            try {
                await loadCSVData();
                let totalProgress = 0;
                const progressPerPDF = 90 / availablePDFs.length;
                for (let i = 0; i < availablePDFs.length; i++) {
                    const pdfInfo = availablePDFs[i];
                    updateProgress(10 + (i * progressPerPDF), `Memuat ${pdfInfo.name}...`);
                    try {
                        const loadingTask = pdfjsLib.getDocument(pdfInfo.file);
                        const pdf = await loadingTask.promise;
                        pdfDatabase.set(pdfInfo.id, { pdf: pdf, info: pdfInfo, totalPages: pdf.numPages });
                        updateProgress(10 + (i * progressPerPDF) + (progressPerPDF * 0.3), `Mengindex teks ${pdfInfo.name}...`);
                        await indexPDFText(pdf, pdfInfo);
                        updateProgress(10 + ((i + 1) * progressPerPDF), `Selesai memuat ${pdfInfo.name}`);
                    } catch (error) {
                        console.error(`Error loading ${pdfInfo.file}:`, error);
                    }
                }
                updateProgress(95, 'Finalisasi sistem...');
                await saveIndexToStorage();
                updateProgress(100, 'Sistem siap!');
                setTimeout(() => {
                    document.getElementById('initOverlay').style.display = 'none';
                    isSystemReady = true;
                    showSystemStatus(`‚úÖ Sistem siap! ${availablePDFs.length} file PDF telah diindex. Database berisi ${textIndex.size} entri pencarian.`);
                }, 1000);
            } catch (error) {
                console.error('Error during initialization:', error);
                updateProgress(100, 'Error inisialisasi');
                setTimeout(() => {
                    document.getElementById('initOverlay').style.display = 'none';
                    showSystemStatus('‚ùå Terjadi error saat inisialisasi sistem. Beberapa fitur mungkin tidak berfungsi optimal.', true);
                }, 2000);
            }
        }
        
        async function indexPDFText(pdf, pdfInfo) {
            const totalPages = pdf.numPages;
            for (let pageNum = 1; pageNum <= totalPages; pageNum++) {
                try {
                    const page = await pdf.getPage(pageNum);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    const indexKey = `${pdfInfo.id}_page_${pageNum}`;
                    textIndex.set(indexKey, { pdfId: pdfInfo.id, pdfInfo: pdfInfo, pageNumber: pageNum, text: pageText.toLowerCase(), originalText: pageText, textItems: textContent.items });
                } catch (error) {
                    console.error(`Error indexing page ${pageNum} of ${pdfInfo.name}:`, error);
                }
            }
        }
        
        async function saveIndexToStorage() {
            try {
                const indexData = {};
                let count = 0;
                for (const [key, value] of textIndex.entries()) {
                    indexData[key] = { pdfId: value.pdfId, pageNumber: value.pageNumber, text: value.text, originalText: value.originalText };
                    count++;
                    if (count > 1000) break;
                }
                localStorage.setItem('vkrn_text_index', JSON.stringify({ data: indexData, timestamp: Date.now(), version: '1.0' }));
            } catch (error) {
                console.warn('Gagal menyimpan index ke localStorage:', error);
            }
        }
        
        function loadIndexFromStorage() {
            try {
                const stored = localStorage.getItem('vkrn_text_index');
                if (stored) {
                    const parsed = JSON.parse(stored);
                    const age = Date.now() - parsed.timestamp;
                    if (age < 7 * 24 * 60 * 60 * 1000) {
                        for (const [key, value] of Object.entries(parsed.data)) {
                            textIndex.set(key, value);
                        }
                        return true;
                    }
                }
            } catch (error) {
                console.warn('Gagal memuat index dari localStorage:', error);
            }
            return false;
        }
        
        function instantSearch(searchTerm) {
            const results = [];
            const searchTermLower = searchTerm.toLowerCase();
            for (const [key, indexEntry] of textIndex.entries()) {
                if (indexEntry.text.includes(searchTermLower)) {
                    results.push(indexEntry);
                }
            }
            return results;
        }
        
        async function loadCSVData() {
            try {
                const response = await fetch('vkrn.csv');
                const csvText = await response.text();
                const lines = csvText.split('\n');
                const headers = lines[0].split(',').map(h => h.trim());
                for (let i = 1; i < lines.length; i++) {
                    const currentLine = lines[i].split(',');
                    if (currentLine.length === headers.length && currentLine[0].trim() !== '') {
                        const obj = {};
                        for (let j = 0; j < headers.length; j++) {
                            obj[headers[j]] = currentLine[j].trim();
                        }
                        csvData.push(obj);
                    }
                }
            } catch (error) {
                console.error('Gagal memuat file CSV:', error);
                throw error;
            }
        }
        
        function toggleSearchDisplay(showResults = false) {
            const searchContainer = document.getElementById('searchContainer');
            const searchAgainContainer = document.getElementById('searchAgainContainer');
            if (showResults) {
                searchContainer.classList.add('hidden');
                searchAgainContainer.classList.add('show');
                hasSearchResults = true;
            } else {
                searchContainer.classList.remove('hidden');
                searchAgainContainer.classList.remove('show');
                hasSearchResults = false;
            }
        }

        function searchAgain() {
            toggleSearchDisplay(false);
            document.getElementById('resultsContainer').innerHTML = '';
            document.getElementById('pdfContainer').style.display = 'none';
            document.getElementById('searchInput').value = '';
            document.getElementById('searchInput').focus();
        }
        
        function performSearch(keyword) {
            if (keyword.trim() === "") {
                alert('Silakan masukkan kata kunci pencarian');
                return;
            }
            if (!isSystemReady) {
                alert('Sistem masih dalam proses inisialisasi. Mohon tunggu sebentar...');
                return;
            }
            document.getElementById('searchInput').value = '';
            document.getElementById('searchInput').blur();
            keyword = keyword.toLowerCase();
            const results = csvData.filter(item => {
                for (const key in item) {
                    if (item[key].toLowerCase().includes(keyword)) {
                        return true;
                    }
                }
                return false;
            });
            displayResults(results);
            if (results.length > 0) {
                toggleSearchDisplay(true);
            }
        }
        
        function displayResults(results) {
            const resultsContainer = document.getElementById('resultsContainer');
            if (results.length === 0) {
                resultsContainer.innerHTML = '<div class="no-results">Tidak ditemukan data yang sesuai</div>';
                document.getElementById('pdfContainer').style.display = 'none';
                return;
            }
            let html = `<div class="results-count">üìä Ditemukan ${results.length} data:</div>`;
            results.forEach((item, index) => {
                html += '<div class="result-item">';
                for (const key in item) {
                    if (key === 'IDPEL') {
                        html += `<div class="idpel"><strong>${key}:</strong> ${item[key]}</div>`;
                    } else {
                        html += `<p><strong>${key}:</strong> ${item[key]}</p>`;
                    }
                }
                if (item.IDPEL && item.IDPEL.trim() !== '') {
                    html += `<button class="show-program-btn instant" onclick="showProgram('${item.IDPEL}')">üìÑ Tampilkan Program (Instan)<br>IDPEL: ${item.IDPEL}</button>`;
                }
                html += '</div>';
            });
            resultsContainer.innerHTML = html;
        }
        
        async function showProgram(idpel) {
            const pdfContainer = document.getElementById('pdfContainer');
            const pdfViewer = document.getElementById('pdfViewer');
            if (!isSystemReady) {
                alert('Sistem masih dalam proses inisialisasi. Mohon tunggu sebentar...');
                return;
            }
            searchIdpel = idpel;
            pdfContainer.style.display = 'block';
            pdfContainer.scrollIntoView({ behavior: 'smooth' });
            const searchResults = instantSearch(idpel);
            if (searchResults.length === 0) {
                pdfViewer.innerHTML = `<div class="error-message">üîç IDPEL "${idpel}" tidak ditemukan dalam database PDF</div>`;
                return;
            }
            pdfViewer.innerHTML = '<div style="text-align: center; padding: 20px; color: #7f8c8d;">‚ö° Memuat hasil pencarian instan...</div>';
            await renderFoundPages(searchResults);
        }
        
        async function renderFoundPages(searchResults) {
            const pdfViewer = document.getElementById('pdfViewer');
            pdfViewer.innerHTML = '';
            const groupedResults = new Map();
            for (const result of searchResults) {
                if (!groupedResults.has(result.pdfId)) {
                    groupedResults.set(result.pdfId, []);
                }
                groupedResults.get(result.pdfId).push(result);
            }
            for (const [pdfId, pages] of groupedResults.entries()) {
                const pdfData = pdfDatabase.get(pdfId);
                if (!pdfData) continue;
                for (const pageResult of pages) {
                    try {
                        const page = await pdfData.pdf.getPage(pageResult.pageNumber);
                        const containerWidth = pdfViewer.clientWidth - 40;
                        const baseViewport = page.getViewport({ scale: 1 });
                        const scale = containerWidth / baseViewport.width;
                        const canvas = await renderPageToCanvas(page, scale);
                        const pageDiv = document.createElement('div');
                        pageDiv.className = 'pdf-page';
                        pageDiv.appendChild(canvas);
                        await highlightTextInPage(page, pageDiv, page.getViewport({ scale: scale }), searchIdpel);
                        pdfViewer.appendChild(pageDiv);
                    } catch (error) {
                        console.error(`Error rendering page ${pageResult.pageNumber}:`, error);
                    }
                }
            }
        }
        
        async function renderPageToCanvas(page, scale) {
            const scaledViewport = page.getViewport({ scale: scale });
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            const outputScale = devicePixelRatio;
            canvas.width = Math.floor(scaledViewport.width * outputScale);
            canvas.height = Math.floor(scaledViewport.height * outputScale);
            canvas.style.width = Math.floor(scaledViewport.width) + "px";
            canvas.style.height = Math.floor(scaledViewport.height) + "px";
            const transform = outputScale !== 1 ? [outputScale, 0, 0, outputScale, 0, 0] : null;
            context.imageSmoothingEnabled = true;
            context.imageSmoothingQuality = 'high';
            canvas.className = 'pdf-canvas';
            const renderContext = {
                canvasContext: context,
                viewport: scaledViewport,
                transform: transform
            };
            await page.render(renderContext).promise;
            return canvas;
        }
        
        async function highlightTextInPage(page, pageDiv, viewport, searchText) {
            try {
                const textContent = await page.getTextContent();
                textContent.items.forEach(item => {
                    if (item.str.toLowerCase().includes(searchText.toLowerCase())) {
                        const highlight = document.createElement('div');
                        highlight.className = 'highlight-overlay';
                        const transform = pdfjsLib.Util.transform(viewport.transform, item.transform);
                        const left = transform[4];
                        const top = viewport.height - transform[5] - item.height;
                        highlight.style.left = left + 'px';
                        highlight.style.top = top + 'px';
                        highlight.style.width = item.width + 'px';
                        highlight.style.height = item.height + 'px';
                        pageDiv.appendChild(highlight);
                    }
                });
            } catch (error) {
                console.error('Error highlighting text:', error);
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            // Tidak ada initializeSystem otomatis
            document.getElementById('searchButton').addEventListener('click', () => {
                const keyword = document.getElementById('searchInput').value;
                performSearch(keyword);
            });
            document.getElementById('searchInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    const keyword = document.getElementById('searchInput').value;
                    performSearch(keyword);
                }
            });
            document.getElementById('searchAgainBtn').addEventListener('click', searchAgain);
            document.getElementById('refreshIndexBtn').addEventListener('click', () => {
                // Tampilkan overlay dan mulai indexing!
                initializeSystem();
            });
        });
    </script>
</body>
    </html>
